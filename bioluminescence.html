<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000000;
        }
    </style>
</head>
<body>
    <script>
        let w = 10;
        let rez = 0.001;
        let amount = 1000;
        let timeOffset = 0;
        
        // Arrays to store particle information
        let prevPositions = [];
        let glowIntensities = [];
        let velocities = [];
        
        // Target percentage of particles that should glow
        const TARGET_GLOW_PERCENTAGE = 0.2;
        let velocityThreshold = 8;
        
        function setup() {
            createCanvas(700, 700);
            background('#000000');
            
            // Initialize arrays for particle tracking
            let leeway = 500;
            for (let i = -leeway; i < width + leeway; i += w) {
                for (let j = -leeway; j < height + leeway; j += w) {
                    prevPositions.push({x: i, y: j});
                    glowIntensities.push(0);
                    velocities.push(0);
                }
            }
        }

        function adjustVelocityThreshold() {
            // Count glowing particles
            let glowingCount = glowIntensities.filter(g => g > 0).length;
            let totalParticles = glowIntensities.length;
            let currentPercentage = glowingCount / totalParticles;
            
            // Adjust threshold based on difference from target
            if (currentPercentage > TARGET_GLOW_PERCENTAGE) {
                velocityThreshold *= 1.01; // Gradually increase threshold
            } else if (currentPercentage < TARGET_GLOW_PERCENTAGE * 0.8) {
                velocityThreshold *= 0.99; // Gradually decrease threshold
            }
            
            // Keep threshold within reasonable bounds
            velocityThreshold = constrain(velocityThreshold, 4, 20);
        }

        function draw() {
            background(0, 20);
            
            noStroke();
            
            let leeway = 500;
            timeOffset += 0.002;
            
            let particleIndex = 0;

            for (let i = -leeway; i < width + leeway; i += w) {
                for (let j = -leeway; j < height + leeway; j += w) {
                    let xoff = i * rez + timeOffset;
                    let yoff = j * rez + timeOffset;
                    
                    let n1 = noise(xoff, yoff);
                    let n2 = noise(xoff * 2, yoff * 2 + 1000);
                    
                    // Create more natural movement patterns
                    let nx = i + (n1 * amount - amount/2);
                    let ny = j + (n2 * amount - amount/2);
                    
                    // Add subtle wave motion
                    ny += sin(i * 0.02 + timeOffset * 3) * 15;
                    
                    // Calculate velocity
                    let dx = nx - prevPositions[particleIndex].x;
                    let dy = ny - prevPositions[particleIndex].y;
                    let velocity = sqrt(dx*dx + dy*dy);
                    velocities[particleIndex] = velocity;
                    
                    // Update previous position
                    prevPositions[particleIndex].x = nx;
                    prevPositions[particleIndex].y = ny;
                    
                    // Update glow based on velocity and threshold
                    if (velocity > velocityThreshold) {
                        glowIntensities[particleIndex] = min(glowIntensities[particleIndex] + 0.5, 1);
                    } else {
                        glowIntensities[particleIndex] = max(glowIntensities[particleIndex] - 0.02, 0);
                    }
                    
                    let size = map(n1 * n2, 0, 1, 1, 3);
                    let alpha = map(ny, 0, height, 255, 100);
                    
                    // Create bioluminescent glow effect
                    if (glowIntensities[particleIndex] > 0) {
                        // Outer glow
                        fill(64, 220, 255, alpha * 0.2 * glowIntensities[particleIndex]);
                        circle(nx, ny, size * 3);
                        
                        // Inner bright dot
                        fill(128, 255, 255, alpha * glowIntensities[particleIndex]);
                        circle(nx, ny, size);
                    } else {
                        fill(255, alpha * 0.3); // Reduced base particle brightness
                        circle(nx, ny, size);
                    }
                    
                    particleIndex++;
                }
            }

            // Adjust threshold periodically
            if (frameCount % 30 === 0) {
                adjustVelocityThreshold();
            }
        }
    </script>
</body>
</html>