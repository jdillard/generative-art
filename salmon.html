<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #001828;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <script>
        let salmon = [];
        let flowField;
        let lifecycleStage = 0;
        let timeInStage = 0;

        class Salmon {
            constructor(x, y) {
                this.pos = createVector(x, y);
                // Initialize with a random velocity
                this.vel = p5.Vector.random2D();
                this.vel.mult(random(2, 4));
                this.acc = createVector(0, 0);
                this.maxSpeed = random(2, 4);
                this.size = random(4, 8);
                this.age = 0;
                this.lifeStage = 0;
                this.color = color(255, 150, 150);
                // Add minimum speed
                this.minSpeed = 1.5;
            }

            update() {
                this.age += 0.01;
                this.pos.add(this.vel);
                this.vel.add(this.acc);
                this.vel.limit(this.maxSpeed);
                
                // Ensure minimum speed
                if (this.vel.mag() < this.minSpeed) {
                    this.vel.normalize();
                    this.vel.mult(this.minSpeed);
                }
                
                this.acc.mult(0);

                if (this.lifeStage === 0) {
                    this.color = color(255, 150, 150, 200);
                } else if (this.lifeStage === 1) {
                    this.color = color(100, 150, 255, 200);
                } else {
                    this.color = color(200, 100, 100, 200);
                }

                if (this.pos.x < 0) this.pos.x = width;
                if (this.pos.x > width) this.pos.x = 0;
                if (this.pos.y < 0) this.pos.y = height;
                if (this.pos.y > height) this.pos.y = 0;
            }

            follow(flowfield) {
                let x = floor(this.pos.x / 20);
                let y = floor(this.pos.y / 20);
                let index = x + y * cols;
                let force = flowfield[index] || createVector(0, 0);
                // Increase force magnitude
                force.mult(1.5);
                this.applyForce(force);
            }

            applyForce(force) {
                this.acc.add(force);
            }

            draw() {
                push();
                translate(this.pos.x, this.pos.y);
                rotate(this.vel.heading() + PI/2);
                
                fill(this.color);
                noStroke();
                
                beginShape();
                vertex(0, -this.size * 2);
                bezierVertex(
                    this.size, -this.size, 
                    this.size, this.size, 
                    0, this.size * 2
                );
                bezierVertex(
                    -this.size, this.size,
                    -this.size, -this.size,
                    0, -this.size * 2
                );
                endShape(CLOSE);

                fill(this.color);
                triangle(
                    0, this.size * 2,
                    -this.size, this.size * 3,
                    this.size, this.size * 3
                );
                pop();
            }
        }

        let cols, rows;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            updateGrid();
            
            const numSalmon = floor((width * height) / 10000);
            for (let i = 0; i < numSalmon; i++) {
                salmon.push(new Salmon(random(width), height - random(100)));
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            updateGrid();
        }

        function updateGrid() {
            cols = floor(width / 20);
            rows = floor(height / 20);
        }

        function draw() {
            background(0, 24, 40, 20);
            
            timeInStage += 0.005;
            if (timeInStage > 1) {
                timeInStage = 0;
                lifecycleStage = (lifecycleStage + 1) % 3;
            }

            flowField = new Array(cols * rows);
            let yoff = 0;
            for (let y = 0; y < rows; y++) {
                let xoff = 0;
                for (let x = 0; x < cols; x++) {
                    let index = x + y * cols;
                    let angle = noise(xoff, yoff, frameCount * 0.002) * TWO_PI * 2;
                    
                    if (lifecycleStage === 0) {
                        angle = angle * 0.5 + PI/2;
                    } else if (lifecycleStage === 1) {
                        angle = angle * 2;
                    } else {
                        angle = angle * 0.5 - PI/2;
                    }
                    
                    let v = p5.Vector.fromAngle(angle);
                    v.setMag(0.2); // Increased force magnitude
                    flowField[index] = v;
                    xoff += 0.1;
                }
                yoff += 0.1;
            }

            for (let fish of salmon) {
                fish.follow(flowField);
                fish.update();
                
                if (lifecycleStage === 0 && fish.pos.y > height * 0.7) {
                    fish.lifeStage = 0;
                } else if (lifecycleStage === 1) {
                    fish.lifeStage = 1;
                } else if (lifecycleStage === 2 && fish.pos.y < height * 0.3) {
                    fish.lifeStage = 2;
                }
                
                fish.draw();
            }

            // All labels removed
        }
    </script>
</body>
</html>
