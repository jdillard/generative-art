<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #001828;
        }
    </style>
</head>
<body>
    <script>
        let salmon = [];
        let flowField;
        let lifecycleStage = 0;
        let timeInStage = 0;

        class Salmon {
            constructor(x, y) {
                this.pos = createVector(x, y);
                this.vel = createVector(0, 0);
                this.acc = createVector(0, 0);
                this.maxSpeed = random(2, 4);
                this.size = random(4, 8);
                this.age = 0;
                this.lifeStage = 0; // 0=young, 1=ocean, 2=returning
                this.color = color(255, 150, 150);
            }

            update() {
                this.age += 0.01;
                this.pos.add(this.vel);
                this.vel.add(this.acc);
                this.vel.limit(this.maxSpeed);
                this.acc.mult(0);

                // Update color based on life stage
                if (this.lifeStage === 0) {
                    this.color = color(255, 150, 150, 200); // Young salmon
                } else if (this.lifeStage === 1) {
                    this.color = color(100, 150, 255, 200); // Ocean phase
                } else {
                    this.color = color(200, 100, 100, 200); // Spawning phase
                }

                // Wrap around screen
                if (this.pos.x < 0) this.pos.x = width;
                if (this.pos.x > width) this.pos.x = 0;
                if (this.pos.y < 0) this.pos.y = height;
                if (this.pos.y > height) this.pos.y = 0;
            }

            follow(flowfield) {
                let x = floor(this.pos.x / 20);
                let y = floor(this.pos.y / 20);
                let index = x + y * cols;
                let force = flowfield[index] || createVector(0, 0);
                this.applyForce(force);
            }

            applyForce(force) {
                this.acc.add(force);
            }

            draw() {
                push();
                translate(this.pos.x, this.pos.y);
                rotate(this.vel.heading() + PI/2);
                
                // Draw fish body
                fill(this.color);
                noStroke();
                
                // Fish shape
                beginShape();
                vertex(0, -this.size * 2);
                bezierVertex(
                    this.size, -this.size, 
                    this.size, this.size, 
                    0, this.size * 2
                );
                bezierVertex(
                    -this.size, this.size,
                    -this.size, -this.size,
                    0, -this.size * 2
                );
                endShape(CLOSE);

                // Tail
                fill(this.color);
                triangle(
                    0, this.size * 2,
                    -this.size, this.size * 3,
                    this.size, this.size * 3
                );
                pop();
            }
        }

        let cols, rows;

        function setup() {
            createCanvas(800, 600);
            cols = floor(width / 20);
            rows = floor(height / 20);

            // Create initial salmon
            for (let i = 0; i < 50; i++) {
                salmon.push(new Salmon(random(width), height - random(100)));
            }
        }

        function draw() {
            background(0, 24, 40, 20);
            
            // Update lifecycle stage
            timeInStage += 0.005;
            if (timeInStage > 1) {
                timeInStage = 0;
                lifecycleStage = (lifecycleStage + 1) % 3;
            }

            // Create flow field
            flowField = new Array(cols * rows);
            let yoff = 0;
            for (let y = 0; y < rows; y++) {
                let xoff = 0;
                for (let x = 0; x < cols; x++) {
                    let index = x + y * cols;
                    let angle = noise(xoff, yoff, frameCount * 0.002) * TWO_PI * 2;
                    
                    // Modify flow based on lifecycle stage
                    if (lifecycleStage === 0) {
                        // Moving downstream
                        angle = angle * 0.5 + PI/2;
                    } else if (lifecycleStage === 1) {
                        // Ocean patterns
                        angle = angle * 2;
                    } else {
                        // Moving upstream
                        angle = angle * 0.5 - PI/2;
                    }
                    
                    let v = p5.Vector.fromAngle(angle);
                    v.setMag(0.1);
                    flowField[index] = v;
                    xoff += 0.1;
                }
                yoff += 0.1;
            }

            // Update and draw salmon
            for (let fish of salmon) {
                fish.follow(flowField);
                fish.update();
                
                // Update life stage based on position and global lifecycle
                if (lifecycleStage === 0 && fish.pos.y > height * 0.7) {
                    fish.lifeStage = 0;
                } else if (lifecycleStage === 1) {
                    fish.lifeStage = 1;
                } else if (lifecycleStage === 2 && fish.pos.y < height * 0.3) {
                    fish.lifeStage = 2;
                }
                
                fish.draw();
            }

            // Draw environment hints
            noStroke();
            // River banks
            fill(139, 69, 19, 50);
            rect(0, 0, width, 50);
            rect(0, height - 50, width, 50);
            
            // Stage indicator
            fill(255, 100);
            textSize(16);
            textAlign(LEFT, TOP);
            let stageText = lifecycleStage === 0 ? "Migration to Ocean" :
                           lifecycleStage === 1 ? "Ocean Life" : "Returning to Spawn";
            text(stageText, 20, 20);
        }
    </script>
</body>
</html>