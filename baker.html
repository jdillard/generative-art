<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mountain Terrain (Optimized)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgb(25, 25, 35);
        }
        
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <script>
        let terrain = [];
        let cols, rows;
        const scl = 30; // Increased scale for fewer vertices
        let flying = 0;
        let rotation = 0;
        let graphics; // Off-screen buffer

        const colors = [
            [40, 42, 54],     // Dark base
            [86, 67, 104],    // Deep purple-gray
            [191, 131, 170],  // Mauve/pink
            [255, 175, 189],  // Soft pink
            [255, 233, 235],  // Snow with pink tint
            [255, 255, 255]   // Pure white
        ];

        const backgroundColor = [25, 25, 35];
        const colorCache = new Map(); // Cache for color calculations

        function setup() {
            createCanvas(windowWidth, windowHeight, WEBGL);
            graphics = createGraphics(width, height, WEBGL);
            frameRate(30); // Limit frame rate
            updateTerrain();
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            graphics = createGraphics(width, height, WEBGL);
            updateTerrain();
        }

        function updateTerrain() {
            cols = ceil(width / scl);
            rows = ceil(height / scl);

            // Preallocate terrain array
            terrain = new Array(cols);
            for (let x = 0; x < cols; x++) {
                terrain[x] = new Array(rows).fill(0);
            }
        }

        function getColorForHeight(h) {
            // Check cache first
            const cacheKey = Math.floor(h * 10) / 10; // Round to 1 decimal for caching
            if (colorCache.has(cacheKey)) {
                return colorCache.get(cacheKey);
            }

            const snowLine = 200;
            let colorIndex;
            
            if (h > snowLine) {
                colorIndex = map(h, snowLine, 350, 4, 5);
            } else {
                colorIndex = map(h, -100, snowLine, 0, 4);
            }
            
            colorIndex = constrain(colorIndex, 0, colors.length - 1);
            const index = floor(colorIndex);
            const blend = colorIndex - index;
            
            let lineColor;
            if (index < colors.length - 1) {
                const c1 = colors[index];
                const c2 = colors[index + 1];
                const r = lerp(c1[0], c2[0], blend);
                const g = lerp(c1[1], c2[1], blend);
                const b = lerp(c1[2], c2[2], blend);
                lineColor = color(r, g, b);
            } else {
                lineColor = color(colors[colors.length - 1]);
            }

            // Store in cache
            colorCache.set(cacheKey, lineColor);
            return lineColor;
        }

        function draw() {
            background(backgroundColor);
            
            rotateX(PI/3);
            rotateZ(rotation);
            rotation += 0.005;
            translate(-width/2, -height/2);

            // Update terrain heights
            let yoff = flying;
            const centerX = cols/2;
            const centerY = rows/2;
            
            for (let y = 0; y < rows; y++) {
                let xoff = 0;
                for (let x = 0; x < cols; x++) {
                    const distance = dist(x, y, centerX, centerY);
                    const peakHeight = constrain(map(distance, 0, cols/3, 300, 0), 0, 300);
                    
                    const baseNoise = noise(xoff, yoff);
                    const detailNoise = noise(xoff * 2, yoff * 2) * 0.5;
                    terrain[x][y] = map(baseNoise + detailNoise, 0, 1.5, -100, 100) + peakHeight;
                    
                    xoff += 0.1;
                }
                yoff += 0.1;
            }
            flying -= 0.003;

            // Render terrain
            for (let y = 0; y < rows - 1; y++) {
                beginShape(TRIANGLE_STRIP);
                for (let x = 0; x < cols; x++) {
                    const h1 = terrain[x][y];
                    const h2 = terrain[x][y + 1];
                    
                    stroke(getColorForHeight(h1));
                    strokeWeight(1);
                    fill(backgroundColor);
                    
                    vertex(x * scl, y * scl, h1);
                    vertex(x * scl, (y + 1) * scl, h2);
                }
                endShape();
            }
        }
    </script>
</body>
</html>
